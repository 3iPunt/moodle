{"version":3,"file":"question.min.js","sources":["../src/question.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Question class for drag and drop marker question type, used to support the question and preview pages.\n *\n * @package    qtype_ddmarker\n * @subpackage question\n * @copyright  2018 The Open University\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/dragdrop', 'qtype_ddmarker/shapes', 'core/key_codes'], function($, dragDrop, Shapes, keys) {\n\n    \"use strict\";\n\n    /**\n     * Object to handle one drag-drop markers question.\n     *\n     * @param {String} containerId id of the outer div for this question.\n     * @param {boolean} readOnly whether the question is being displayed read-only.\n     * @param {Object[]} visibleDropZones the geometry of any drop-zones to show.\n     *      Objects have fields shape, coords and markertext.\n     * @constructor\n     */\n    function DragDropMarkersQuestion(containerId, readOnly, visibleDropZones) {\n        var thisQ = this;\n        this.containerId = containerId;\n        this.visibleDropZones = visibleDropZones;\n        this.shapes = [];\n        this.shapeSVGs = [];\n        this.isPrinting = false;\n        if (readOnly) {\n            this.getRoot().addClass('qtype_ddmarker-readonly');\n        }\n        thisQ.cloneDrags();\n        thisQ.repositionDrags();\n        thisQ.drawDropzones();\n    }\n\n    /**\n     * Draws the svg shapes of any drop zones that should be visible for feedback purposes.\n     */\n    DragDropMarkersQuestion.prototype.drawDropzones = function() {\n        if (this.visibleDropZones.length > 0) {\n            var bgImage = this.bgImage();\n\n            this.getRoot().find('div.dropzones').html('<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"dropzones\" ' +\n                'width=\"' + bgImage.outerWidth() + '\" ' +\n                'height=\"' + bgImage.outerHeight() + '\"></svg>');\n            var svg = this.getRoot().find('svg.dropzones');\n\n            var nextColourIndex = 0;\n            for (var dropZoneNo = 0; dropZoneNo < this.visibleDropZones.length; dropZoneNo++) {\n                var colourClass = 'color' + nextColourIndex;\n                nextColourIndex = (nextColourIndex + 1) % 8;\n                this.addDropzone(svg, dropZoneNo, colourClass);\n            }\n        }\n    };\n\n    /**\n     * Adds a dropzone shape with colour, coords and link provided to the array of shapes.\n     *\n     * @param {jQuery} svg the SVG image to which to add this drop zone.\n     * @param {int} dropZoneNo which drop-zone to add.\n     * @param {string} colourClass class name\n     */\n    DragDropMarkersQuestion.prototype.addDropzone = function(svg, dropZoneNo, colourClass) {\n        var dropZone = this.visibleDropZones[dropZoneNo],\n            shape = Shapes.make(dropZone.shape, ''),\n            existingmarkertext,\n            bgRatio = this.bgRatio();\n        if (!shape.parse(dropZone.coords, bgRatio)) {\n            return;\n        }\n\n        existingmarkertext = this.getRoot().find('div.markertexts span.markertext' + dropZoneNo);\n        if (existingmarkertext.length) {\n            if (dropZone.markertext !== '') {\n                existingmarkertext.html(dropZone.markertext);\n            } else {\n                existingmarkertext.remove();\n            }\n        } else if (dropZone.markertext !== '') {\n            var classnames = 'markertext markertext' + dropZoneNo;\n            this.getRoot().find('div.markertexts').append('<span class=\"' + classnames + '\">' +\n                dropZone.markertext + '</span>');\n            var markerspan = this.getRoot().find('div.ddarea div.markertexts span.markertext' + dropZoneNo);\n            if (markerspan.length) {\n                var handles = shape.getHandlePositions();\n                var positionLeft = handles.moveHandle.x - (markerspan.outerWidth() / 2) - 4;\n                var positionTop = handles.moveHandle.y - (markerspan.outerHeight() / 2);\n                markerspan\n                    .css('left', positionLeft)\n                    .css('top', positionTop);\n                markerspan\n                    .data('originX', markerspan.position().left / bgRatio)\n                    .data('originY', markerspan.position().top / bgRatio);\n                this.handleElementScale(markerspan, 'center');\n            }\n        }\n\n        var shapeSVG = shape.makeSvg(svg[0]);\n        shapeSVG.setAttribute('class', 'dropzone ' + colourClass);\n\n        this.shapes[this.shapes.length] = shape;\n        this.shapeSVGs[this.shapeSVGs.length] = shapeSVG;\n    };\n\n    /**\n     * Draws the drag items on the page (and drop zones if required).\n     * The idea is to re-draw all the drags and drops whenever there is a change\n     * like a widow resize or an item dropped in place.\n     */\n    DragDropMarkersQuestion.prototype.repositionDrags = function() {\n        var root = this.getRoot(),\n            thisQ = this;\n\n        root.find('div.draghomes .marker').not('.dragplaceholder').each(function(key, item) {\n            $(item).addClass('unneeded');\n        });\n\n        root.find('input.choices').each(function(key, input) {\n            var choiceNo = thisQ.getChoiceNoFromElement(input),\n                coords = thisQ.getCoords(input);\n            if (coords.length) {\n                var drag = thisQ.getRoot().find('.draghomes' + ' span.marker' + '.choice' + choiceNo).not('.dragplaceholder');\n                drag.remove();\n                for (var i = 0; i < coords.length; i++) {\n                    var dragInDrop = drag.clone();\n                    dragInDrop.data('pagex', coords[i].x).data('pagey', coords[i].y);\n                    thisQ.sendDragToDrop(dragInDrop, false);\n                }\n                thisQ.getDragClone(drag).addClass('active');\n                thisQ.cloneDragIfNeeded(drag);\n            }\n        });\n    };\n\n    /**\n     * Determine what drag items need to be shown and\n     * return coords of all drag items except any that are currently being dragged\n     * based on contents of hidden inputs and whether drags are 'infinite' or how many\n     * drags should be shown.\n     *\n     * @param {jQuery} inputNode\n     * @returns {Point[]} coordinates of however many copies of the drag item should be shown.\n     */\n    DragDropMarkersQuestion.prototype.getCoords = function(inputNode) {\n        var coords = [],\n            val = $(inputNode).val();\n        if (val !== '') {\n            var coordsStrings = val.split(';');\n            for (var i = 0; i < coordsStrings.length; i++) {\n                coords[i] = this.convertToWindowXY(Shapes.Point.parse(coordsStrings[i]));\n            }\n        }\n        return coords;\n    };\n\n    /**\n     * Converts the relative x and y position coordinates into\n     * absolute x and y position coordinates.\n     *\n     * @param {Point} point relative to the background image.\n     * @returns {Point} point relative to the page.\n     */\n    DragDropMarkersQuestion.prototype.convertToWindowXY = function(point) {\n        var bgImage = this.bgImage();\n        // The +1 seems rather odd, but seems to give the best results in\n        // the three main browsers at a range of zoom levels.\n        // (Its due to the 1px border around the image, that shifts the\n        // image pixels by 1 down and to the left.)\n        return point.offset(bgImage.offset().left + 1, bgImage.offset().top + 1);\n    };\n\n    /**\n     * Utility function converting window coordinates to relative to the\n     * background image coordinates.\n     *\n     * @param {Point} point relative to the page.\n     * @returns {Point} point relative to the background image.\n     */\n    DragDropMarkersQuestion.prototype.convertToBgImgXY = function(point) {\n        var bgImage = this.bgImage();\n        return point.offset(-bgImage.offset().left - 1, -bgImage.offset().top - 1);\n    };\n\n    /**\n     * Is the point within the background image?\n     *\n     * @param {Point} point relative to the BG image.\n     * @return {boolean} true it they are.\n     */\n    DragDropMarkersQuestion.prototype.coordsInBgImg = function(point) {\n        var bgImage = this.bgImage();\n        var bgPosition = bgImage.offset();\n\n        return point.x >= bgPosition.left && point.x < bgPosition.left + bgImage.width()\n            && point.y >= bgPosition.top && point.y < bgPosition.top + bgImage.height();\n    };\n\n    /**\n     * Get the outer div for this question.\n     * @returns {jQuery} containing that div.\n     */\n    DragDropMarkersQuestion.prototype.getRoot = function() {\n        return $(document.getElementById(this.containerId));\n    };\n\n    /**\n     * Get the img that is the background image.\n     * @returns {jQuery} containing that img.\n     */\n    DragDropMarkersQuestion.prototype.bgImage = function() {\n        return this.getRoot().find('img.dropbackground');\n    };\n\n    DragDropMarkersQuestion.prototype.handleDragStart = function(e) {\n        var thisQ = this,\n            dragged = $(e.target).closest('.marker');\n\n        var info = dragDrop.prepare(e);\n        if (!info.start) {\n            return;\n        }\n\n        dragged.addClass('beingdragged').css('transform', '');\n\n        var placed = !dragged.hasClass('unneeded');\n        if (!placed) {\n            var hiddenDrag = thisQ.getDragClone(dragged);\n            if (hiddenDrag.length) {\n                hiddenDrag.addClass('active');\n                dragged.offset(hiddenDrag.offset());\n            }\n        }\n\n        dragDrop.start(e, dragged, function() {\n            void (1);\n        }, function(x, y, dragged) {\n            thisQ.dragEnd(dragged);\n        });\n    };\n\n    /**\n     * Functionality at the end of a drag drop.\n     * @param {jQuery} dragged the marker that was dragged.\n     */\n    DragDropMarkersQuestion.prototype.dragEnd = function(dragged) {\n        var placed = false,\n            choiceNo = this.getChoiceNoFromElement(dragged),\n            bgRatio = this.bgRatio(),\n            dragXY;\n\n        dragged.data('pagex', dragged.offset().left).data('pagey', dragged.offset().top);\n        dragXY = new Shapes.Point(dragged.data('pagex'), dragged.data('pagey'));\n        if (this.coordsInBgImg(dragXY)) {\n            this.sendDragToDrop(dragged, true);\n            placed = true;\n\n            // It seems that the dragdrop sometimes leaves the drag\n            // one pixel out of position. Put it in exactly the right place.\n            var bgImgXY = this.convertToBgImgXY(dragXY);\n            bgImgXY = new Shapes.Point(bgImgXY.x / bgRatio, bgImgXY.y / bgRatio);\n            dragged.data('originX', bgImgXY.x).data('originY', bgImgXY.y);\n        }\n\n        if (!placed) {\n            this.sendDragHome(dragged);\n            this.removeDragIfNeeded(dragged);\n        } else {\n            this.cloneDragIfNeeded(dragged);\n        }\n\n        this.saveCoordsForChoice(choiceNo);\n    };\n\n    /**\n     * Save the coordinates for a dropped item in the form field.\n     * @param {Number} choiceNo which copy of the choice this was.\n     */\n    DragDropMarkersQuestion.prototype.saveCoordsForChoice = function(choiceNo) {\n        var coords = [],\n            items = this.getRoot().find('div.droparea span.marker.choice' + choiceNo),\n            thiQ = this,\n            bgRatio = this.bgRatio();\n\n        if (items.length) {\n            items.each(function() {\n                var drag = $(this);\n                if (!drag.hasClass('beingdragged')) {\n                    var dragXY = new Shapes.Point(drag.data('pagex'), drag.data('pagey'));\n                    if (thiQ.coordsInBgImg(dragXY)) {\n                        var bgImgXY = thiQ.convertToBgImgXY(dragXY);\n                        bgImgXY = new Shapes.Point(bgImgXY.x / bgRatio, bgImgXY.y / bgRatio);\n                        coords[coords.length] = bgImgXY;\n                    }\n                }\n            });\n        }\n\n        this.getRoot().find('input.choice' + choiceNo).val(coords.join(';'));\n    };\n\n    /**\n     * Handle key down / press events on markers.\n     * @param {KeyboardEvent} e\n     */\n    DragDropMarkersQuestion.prototype.handleKeyPress = function(e) {\n        var drag = $(e.target).closest('.marker'),\n            point = new Shapes.Point(drag.offset().left, drag.offset().top),\n            choiceNo = this.getChoiceNoFromElement(drag);\n\n        switch (e.keyCode) {\n            case keys.arrowLeft:\n            case 65: // A.\n                point.x -= 1;\n                break;\n            case keys.arrowRight:\n            case 68: // D.\n                point.x += 1;\n                break;\n            case keys.arrowDown:\n            case 83: // S.\n                point.y += 1;\n                break;\n            case keys.arrowUp:\n            case 87: // W.\n                point.y -= 1;\n                break;\n            case keys.space:\n            case keys.escape:\n                point = null;\n                break;\n            default:\n                return; // Ingore other keys.\n        }\n        e.preventDefault();\n\n        if (point !== null) {\n            point = this.constrainToBgImg(point);\n            drag.offset({'left': point.x, 'top': point.y});\n            drag.data('pagex', drag.offset().left).data('pagey', drag.offset().top);\n            var dragXY = this.convertToBgImgXY(new Shapes.Point(drag.data('pagex'), drag.data('pagey')));\n            drag.data('originX', dragXY.x / this.bgRatio()).data('originY', dragXY.y / this.bgRatio());\n            if (this.coordsInBgImg(new Shapes.Point(drag.offset().left, drag.offset().top))) {\n                if (drag.hasClass('unneeded')) {\n                    this.sendDragToDrop(drag, true);\n                    var hiddenDrag = this.getDragClone(drag);\n                    if (hiddenDrag.length) {\n                        hiddenDrag.addClass('active');\n                    }\n                    this.cloneDragIfNeeded(drag);\n                }\n            }\n        } else {\n            drag.css('left', '').css('top', '');\n            drag.data('pagex', drag.offset().left).data('pagey', drag.offset().top);\n            this.sendDragHome(drag);\n            this.removeDragIfNeeded(drag);\n        }\n        drag.focus();\n        this.saveCoordsForChoice(choiceNo);\n    };\n\n    /**\n     * Makes sure the dragged item always exists within the background image area.\n     *\n     * @param {Point} windowxy\n     * @returns {Point} coordinates\n     */\n    DragDropMarkersQuestion.prototype.constrainToBgImg = function(windowxy) {\n        var bgImg = this.bgImage(),\n            bgImgXY = this.convertToBgImgXY(windowxy);\n        bgImgXY.x = Math.max(0, bgImgXY.x);\n        bgImgXY.y = Math.max(0, bgImgXY.y);\n        bgImgXY.x = Math.min(bgImg.width(), bgImgXY.x);\n        bgImgXY.y = Math.min(bgImg.height(), bgImgXY.y);\n        return this.convertToWindowXY(bgImgXY);\n    };\n\n    /**\n     * Returns the choice number for a node.\n     *\n     * @param {Element|jQuery} node\n     * @returns {Number}\n     */\n    DragDropMarkersQuestion.prototype.getChoiceNoFromElement = function(node) {\n        return Number(this.getClassnameNumericSuffix(node, 'choice'));\n    };\n\n    /**\n     * Returns the numeric part of a class with the given prefix.\n     *\n     * @param {Element|jQuery} node\n     * @param {String} prefix\n     * @returns {Number|null}\n     */\n    DragDropMarkersQuestion.prototype.getClassnameNumericSuffix = function(node, prefix) {\n        var classes = $(node).attr('class');\n        if (classes !== undefined && classes !== '') {\n            var classesarr = classes.split(' ');\n            for (var index = 0; index < classesarr.length; index++) {\n                var patt1 = new RegExp('^' + prefix + '([0-9])+$');\n                if (patt1.test(classesarr[index])) {\n                    var patt2 = new RegExp('([0-9])+$');\n                    var match = patt2.exec(classesarr[index]);\n                    return Number(match[0]);\n                }\n            }\n        }\n        return null;\n    };\n\n    /**\n     * Handle when the window is resized.\n     */\n    DragDropMarkersQuestion.prototype.handleResize = function() {\n        var thisQ = this,\n            bgRatio = this.bgRatio();\n        if (this.isPrinting) {\n            bgRatio = 1;\n        }\n\n        this.getRoot().find('div.droparea .marker').not('.beingdragged').each(function(key, drag) {\n            $(drag)\n                .css('left', parseFloat($(drag).data('originX')) * parseFloat(bgRatio))\n                .css('top', parseFloat($(drag).data('originY')) * parseFloat(bgRatio));\n            thisQ.handleElementScale(drag, 'left top');\n        });\n\n        this.getRoot().find('div.droparea svg.dropzones')\n            .width(this.bgImage().width())\n            .height(this.bgImage().height());\n\n        for (var dropZoneNo = 0; dropZoneNo < this.visibleDropZones.length; dropZoneNo++) {\n            var dropZone = thisQ.visibleDropZones[dropZoneNo];\n            var originCoords = dropZone.coords;\n            var shape = thisQ.shapes[dropZoneNo];\n            var shapeSVG = thisQ.shapeSVGs[dropZoneNo];\n            shape.parse(originCoords, bgRatio);\n            shape.updateSvg(shapeSVG);\n\n            var handles = shape.getHandlePositions();\n            var markerSpan = this.getRoot().find('div.ddarea div.markertexts span.markertext' + dropZoneNo);\n            markerSpan\n                .css('left', handles.moveHandle.x - (markerSpan.outerWidth() / 2) - 4)\n                .css('top', handles.moveHandle.y - (markerSpan.outerHeight() / 2));\n            thisQ.handleElementScale(markerSpan, 'center');\n        }\n    };\n\n    /**\n     * Clone the drag.\n     */\n    DragDropMarkersQuestion.prototype.cloneDrags = function() {\n        var thisQ = this;\n        this.getRoot().find('div.draghomes span.marker').each(function(index, draghome) {\n            var drag = $(draghome);\n            var placeHolder = drag.clone();\n            placeHolder.removeClass();\n            placeHolder.addClass('marker');\n            placeHolder.addClass('choice' + thisQ.getChoiceNoFromElement(drag));\n            placeHolder.addClass(thisQ.getDragNoClass(drag, false));\n            placeHolder.addClass('dragplaceholder');\n            drag.before(placeHolder);\n        });\n    };\n\n    /**\n     * Get the drag number of a drag.\n     *\n     * @param {jQuery} drag the drag.\n     * @returns {Number} the drag number.\n     */\n    DragDropMarkersQuestion.prototype.getDragNo = function(drag) {\n        return this.getClassnameNumericSuffix(drag, 'dragno');\n    };\n\n    /**\n     * Get the drag number prefix of a drag.\n     *\n     * @param {jQuery} drag the drag.\n     * @param {Boolean} includeSelector include the CSS selector prefix or not.\n     * @return {String} Class name\n     */\n    DragDropMarkersQuestion.prototype.getDragNoClass = function(drag, includeSelector) {\n        var className = 'dragno' + this.getDragNo(drag);\n        if (this.isInfiniteDrag(drag)) {\n            className = 'infinite';\n        }\n\n        if (includeSelector) {\n            return '.' + className;\n        }\n\n        return className;\n    };\n\n    /**\n     * Get drag clone for a given drag.\n     *\n     * @param {jQuery} drag the drag.\n     * @returns {jQuery} the drag's clone.\n     */\n    DragDropMarkersQuestion.prototype.getDragClone = function(drag) {\n        return this.getRoot().find('.draghomes' + ' span.marker' +\n            '.choice' + this.getChoiceNoFromElement(drag) + this.getDragNoClass(drag, true) + '.dragplaceholder');\n    };\n\n    /**\n     * Get the drop area element.\n     * @returns {jQuery} droparea element.\n     */\n    DragDropMarkersQuestion.prototype.dropArea = function() {\n        return this.getRoot().find('div.droparea');\n    };\n\n    /**\n     * Animate a drag back to its home.\n     *\n     * @param {jQuery} drag the item being moved.\n     */\n    DragDropMarkersQuestion.prototype.sendDragHome = function(drag) {\n        drag.removeClass('beingdragged')\n            .addClass('unneeded')\n            .css('top', '')\n            .css('left', '')\n            .css('transform', '');\n        var placeHolder = this.getDragClone(drag);\n        placeHolder.after(drag);\n        placeHolder.removeClass('active');\n    };\n\n    /**\n     * Animate a drag item into a given place.\n     *\n     * @param {jQuery} drag the item to place.\n     * @param {boolean} isScaling Scaling or not\n     */\n    DragDropMarkersQuestion.prototype.sendDragToDrop = function(drag, isScaling) {\n        var dropArea = this.dropArea(),\n            bgRatio = this.bgRatio();\n        drag.removeClass('beingdragged').removeClass('unneeded');\n        var dragXY = this.convertToBgImgXY(new Shapes.Point(drag.data('pagex'), drag.data('pagey')));\n        if (isScaling) {\n            drag.data('originX', dragXY.x / bgRatio).data('originY', dragXY.y / bgRatio);\n            drag.css('left', dragXY.x).css('top', dragXY.y);\n        } else {\n            drag.data('originX', dragXY.x).data('originY', dragXY.y);\n            drag.css('left', dragXY.x * bgRatio).css('top', dragXY.y * bgRatio);\n        }\n        dropArea.append(drag);\n        this.handleElementScale(drag, 'left top');\n    };\n\n    /**\n     * Clone the drag at the draghome area if needed.\n     *\n     * @param {jQuery} drag the item to place.\n     */\n    DragDropMarkersQuestion.prototype.cloneDragIfNeeded = function(drag) {\n        var inputNode = this.getInput(drag),\n            noOfDrags = Number(this.getClassnameNumericSuffix(inputNode, 'noofdrags')),\n            displayedDragsInDropArea = this.getRoot().find('div.droparea .marker.choice' +\n                this.getChoiceNoFromElement(drag) + this.getDragNoClass(drag, true)).length,\n            displayedDragsInDragHomes = this.getRoot().find('div.draghomes .marker.choice' +\n                this.getChoiceNoFromElement(drag) + this.getDragNoClass(drag, true)).not('.dragplaceholder').length;\n\n        if ((this.isInfiniteDrag(drag) ||\n                !this.isInfiniteDrag(drag) && displayedDragsInDropArea < noOfDrags) && displayedDragsInDragHomes === 0) {\n            var dragClone = drag.clone();\n            dragClone.addClass('unneeded')\n                .css('top', '')\n                .css('left', '')\n                .css('transform', '');\n            this.getDragClone(drag)\n                .removeClass('active')\n                .after(dragClone);\n            questionManager.addEventHandlersToMarker(dragClone);\n        }\n    };\n\n    /**\n     * Remove the clone drag at the draghome area if needed.\n     *\n     * @param {jQuery} drag the item to place.\n     */\n    DragDropMarkersQuestion.prototype.removeDragIfNeeded = function(drag) {\n        var dragsInHome = this.getRoot().find('div.draghomes .marker.choice' +\n            this.getChoiceNoFromElement(drag) + this.getDragNoClass(drag, true)).not('.dragplaceholder');\n        var displayedDrags = dragsInHome.length;\n        while (displayedDrags > 1) {\n            dragsInHome.first().remove();\n            displayedDrags--;\n        }\n    };\n\n    /**\n     * Get the input belong to drag.\n     *\n     * @param {jQuery} drag the item to place.\n     * @returns {jQuery} input element.\n     */\n    DragDropMarkersQuestion.prototype.getInput = function(drag) {\n        var choiceNo = this.getChoiceNoFromElement(drag);\n        return this.getRoot().find('input.choices.choice' + choiceNo);\n    };\n\n    /**\n     * Return the background ratio.\n     *\n     * @returns {number} Background ratio.\n     */\n    DragDropMarkersQuestion.prototype.bgRatio = function() {\n        var bgImg = this.bgImage();\n        var bgImgNaturalWidth = bgImg.get(0).naturalWidth;\n        var bgImgClientWidth = bgImg.width();\n\n        return bgImgClientWidth / bgImgNaturalWidth;\n    };\n\n    /**\n     * Scale the drag if needed.\n     *\n     * @param {jQuery} element the item to place.\n     * @param {String} type scaling type\n     */\n    DragDropMarkersQuestion.prototype.handleElementScale = function(element, type) {\n        var bgRatio = parseFloat(this.bgRatio());\n        if (this.isPrinting) {\n            bgRatio = 1;\n        }\n        $(element).css({\n            '-webkit-transform': 'scale(' + bgRatio + ')',\n            '-moz-transform': 'scale(' + bgRatio + ')',\n            '-ms-transform': 'scale(' + bgRatio + ')',\n            '-o-transform': 'scale(' + bgRatio + ')',\n            'transform': 'scale(' + bgRatio + ')',\n            'transform-origin': type\n        });\n    };\n\n    /**\n     * Check if the given drag is in infinite mode or not.\n     *\n     * @param {jQuery} drag The drag item need to check.\n     */\n    DragDropMarkersQuestion.prototype.isInfiniteDrag = function(drag) {\n        return drag.hasClass('infinite');\n    };\n\n    /**\n     * Singleton that tracks all the DragDropToTextQuestions on this page, and deals\n     * with event dispatching.\n     *\n     * @type {Object}\n     */\n    var questionManager = {\n\n        /**\n         * {boolean} ensures that the event handlers are only initialised once per page.\n         */\n        eventHandlersInitialised: false,\n\n        /**\n         * {boolean} is printing or not.\n         */\n        isPrinting: false,\n\n        /**\n         * {boolean} is keyboard navigation.\n         */\n        isKeyboardNavigation: false,\n\n        /**\n         * {Object} all the questions on this page, indexed by containerId (id on the .que div).\n         */\n        questions: {}, // An object containing all the information about each question on the page.\n\n        /**\n         * Initialise one question.\n         *\n         * @param {String} containerId the id of the div.que that contains this question.\n         * @param {boolean} readOnly whether the question is read-only.\n         * @param {Object[]} visibleDropZones data on any drop zones to draw as part of the feedback.\n         */\n        init: function(containerId, readOnly, visibleDropZones) {\n            questionManager.questions[containerId] =\n                new DragDropMarkersQuestion(containerId, readOnly, visibleDropZones);\n            if (!questionManager.eventHandlersInitialised) {\n                questionManager.setupEventHandlers();\n                questionManager.eventHandlersInitialised = true;\n            }\n        },\n\n        /**\n         * Set up the event handlers that make this question type work. (Done once per page.)\n         */\n        setupEventHandlers: function() {\n            // We do not use the body event here to prevent the other event on Mobile device, such as scroll event.\n            questionManager.addEventHandlersToMarker($('.que.ddmarker:not(.qtype_ddmarker-readonly) div.draghomes .marker'));\n            questionManager.addEventHandlersToMarker($('.que.ddmarker:not(.qtype_ddmarker-readonly) div.droparea .marker'));\n            $(window).on('resize', function() {\n                questionManager.handleWindowResize(false);\n            });\n            window.addEventListener('beforeprint', function() {\n                questionManager.isPrinting = true;\n                questionManager.handleWindowResize(questionManager.isPrinting);\n            });\n            window.addEventListener('afterprint', function() {\n                questionManager.isPrinting = false;\n                questionManager.handleWindowResize(questionManager.isPrinting);\n            });\n            setTimeout(function() {\n                questionManager.fixLayoutIfThingsMoved();\n            }, 100);\n        },\n\n        /**\n         * Binding the event again for newly created element.\n         *\n         * @param {jQuery} element Element to bind the event\n         */\n        addEventHandlersToMarker: function(element) {\n            element\n                .on('mousedown touchstart', questionManager.handleDragStart)\n                .on('keydown keypress', questionManager.handleKeyPress)\n                .focusin(function(e) {\n                    questionManager.handleKeyboardFocus(e, true);\n                })\n                .focusout(function(e) {\n                    questionManager.handleKeyboardFocus(e, false);\n                });\n        },\n\n        /**\n         * Handle mouse down / touch start events on markers.\n         * @param {Event} e the DOM event.\n         */\n        handleDragStart: function(e) {\n            e.preventDefault();\n            var question = questionManager.getQuestionForEvent(e);\n            if (question) {\n                question.handleDragStart(e);\n            }\n        },\n\n        /**\n         * Handle key down / press events on markers.\n         * @param {Event} e\n         */\n        handleKeyPress: function(e) {\n            var question = questionManager.getQuestionForEvent(e);\n            if (question) {\n                question.handleKeyPress(e);\n            }\n        },\n\n        /**\n         * Handle when the window is resized.\n         * @param {boolean} isPrinting\n         */\n        handleWindowResize: function(isPrinting) {\n            for (var containerId in questionManager.questions) {\n                if (questionManager.questions.hasOwnProperty(containerId)) {\n                    questionManager.questions[containerId].isPrinting = isPrinting;\n                    questionManager.questions[containerId].handleResize();\n                }\n            }\n        },\n\n        /**\n         * Handle focus lost events on markers.\n         * @param {Event} e\n         * @param {boolean} isNavigating\n         */\n        handleKeyboardFocus: function(e, isNavigating) {\n            questionManager.isKeyboardNavigation = isNavigating;\n        },\n\n        /**\n         * Sometimes, despite our best efforts, things change in a way that cannot\n         * be specifically caught (e.g. dock expanding or collapsing in Boost).\n         * Therefore, we need to periodically check everything is in the right position.\n         */\n        fixLayoutIfThingsMoved: function() {\n            if (!questionManager.isKeyboardNavigation) {\n                this.handleWindowResize(questionManager.isPrinting);\n            }\n            // We use setTimeout after finishing work, rather than setInterval,\n            // in case positioning things is slow. We want 100 ms gap\n            // between executions, not what setInterval does.\n            setTimeout(function() {\n                questionManager.fixLayoutIfThingsMoved(questionManager.isPrinting);\n            }, 100);\n        },\n\n        /**\n         * Given an event, work out which question it effects.\n         * @param {Event} e the event.\n         * @returns {DragDropMarkersQuestion|undefined} The question, or undefined.\n         */\n        getQuestionForEvent: function(e) {\n            var containerId = $(e.currentTarget).closest('.que.ddmarker').attr('id');\n            return questionManager.questions[containerId];\n        }\n    };\n\n    /**\n     * @alias module:qtype_ddmarker/question\n     */\n    return {\n        /**\n         * Initialise one drag-drop markers question.\n         *\n         * @param {String} containerId id of the outer div for this question.\n         * @param {String} bgImgUrl the URL of the background image.\n         * @param {boolean} readOnly whether the question is being displayed read-only.\n         * @param {String[]} visibleDropZones the geometry of any drop-zones to show.\n         */\n        init: questionManager.init\n    };\n});\n"],"names":["define","$","dragDrop","Shapes","keys","DragDropMarkersQuestion","containerId","readOnly","visibleDropZones","shapes","shapeSVGs","isPrinting","this","getRoot","addClass","cloneDrags","repositionDrags","drawDropzones","prototype","length","bgImage","find","html","outerWidth","outerHeight","svg","nextColourIndex","dropZoneNo","colourClass","addDropzone","existingmarkertext","dropZone","shape","make","bgRatio","parse","coords","markertext","remove","classnames","append","markerspan","handles","getHandlePositions","positionLeft","moveHandle","x","positionTop","y","css","data","position","left","top","handleElementScale","shapeSVG","makeSvg","setAttribute","root","thisQ","not","each","key","item","input","choiceNo","getChoiceNoFromElement","getCoords","drag","i","dragInDrop","clone","sendDragToDrop","getDragClone","cloneDragIfNeeded","inputNode","val","coordsStrings","split","convertToWindowXY","Point","point","offset","convertToBgImgXY","coordsInBgImg","bgPosition","width","height","document","getElementById","handleDragStart","e","dragged","target","closest","prepare","start","hasClass","hiddenDrag","dragEnd","placed","dragXY","bgImgXY","sendDragHome","removeDragIfNeeded","saveCoordsForChoice","items","thiQ","join","handleKeyPress","keyCode","arrowLeft","arrowRight","arrowDown","arrowUp","space","escape","preventDefault","constrainToBgImg","focus","windowxy","bgImg","Math","max","min","node","Number","getClassnameNumericSuffix","prefix","classes","attr","undefined","classesarr","index","patt1","RegExp","test","match","exec","handleResize","parseFloat","originCoords","updateSvg","markerSpan","draghome","placeHolder","removeClass","getDragNoClass","before","getDragNo","includeSelector","className","isInfiniteDrag","dropArea","after","isScaling","getInput","noOfDrags","displayedDragsInDropArea","displayedDragsInDragHomes","dragClone","questionManager","addEventHandlersToMarker","displayedDrags","dragsInHome","first","bgImgNaturalWidth","get","naturalWidth","bgImgClientWidth","element","type","transform","eventHandlersInitialised","isKeyboardNavigation","questions","init","setupEventHandlers","window","on","handleWindowResize","addEventListener","setTimeout","fixLayoutIfThingsMoved","focusin","handleKeyboardFocus","focusout","question","getQuestionForEvent","hasOwnProperty","isNavigating","currentTarget"],"mappings":"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"}